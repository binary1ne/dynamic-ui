<div
  class="min-h-screen flex items-center justify-center px-4 bg-gradient-to-br from-slate-50 to-blue-50 relative overflow-hidden"
>
  <!-- Background Decoration -->
  <div
    class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0"
  >
    <div
      class="absolute -top-24 -left-24 w-96 h-96 bg-primary-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"
    ></div>
    <div
      class="absolute top-0 -right-4 w-72 h-72 bg-accent-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"
    ></div>
    <div
      class="absolute -bottom-8 left-20 w-72 h-72 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"
    ></div>
  </div>

  <div
    class="card max-w-md w-full animate-fade-in relative z-10 !p-8 shadow-xl border-white/50"
  >
    <!-- Logo + Title -->
    <div class="text-center mb-8">
      <div
        class="w-16 h-16 bg-gradient-to-br from-primary-600 to-primary-700 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary-500/30 text-white text-2xl font-bold"
      >
        AI
      </div>
      <h2 class="text-3xl font-bold text-gray-800 tracking-tight">
        Welcome Back
      </h2>
      <p class="text-gray-500 mt-2 text-sm">
        Sign in to your enterprise account
      </p>
    </div>

    <div *ngIf="!showDomainSelection">
      <form (ngSubmit)="onSubmit()" class="space-y-5">
        <!-- Email -->
        <div class="space-y-1.5">
          <label class="block text-sm font-semibold text-gray-700 ml-1"
            >Email Address</label
          >
          <div class="relative group">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="currentColor"
              >
                <path
                  d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                />
                <path
                  d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                />
              </svg>
            </div>
            <input
              type="email"
              [(ngModel)]="email"
              name="email"
              required
              [disabled]="emailChecked"
              (blur)="checkEmail()"
              class="input-field pl-10"
              placeholder="you@company.com"
            />
          </div>
          <button
            *ngIf="emailChecked"
            type="button"
            (click)="resetForm()"
            class="text-xs text-primary-600 hover:text-primary-700 ml-1 mt-1"
          >
            Change email
          </button>
        </div>

        <!-- Password (only shown after email check) -->
        <div *ngIf="emailChecked" class="space-y-1.5 animate-fade-in">
          <label class="block text-sm font-semibold text-gray-700 ml-1"
            >Password</label
          >
          <div class="relative group">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5">
                <path
                  fill-rule="evenodd"
                  d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <input
              type="password"
              [(ngModel)]="password"
              name="password"
              required
              class="input-field pl-10"
              placeholder="••••••••"
            />
          </div>
        </div>

        <!-- Error Message -->
        <div
          *ngIf="error"
          class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm animate-shake"
        >
          {{ error }}
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          [disabled]="loading || !email || (emailChecked && !password)"
          class="btn-primary w-full py-3 font-semibold flex items-center justify-center gap-2"
        >
          <ng-container *ngIf="loading; else btnText">
            <div
              class="animate-spin h-5 w-5 border-b-2 border-white rounded-full"
            ></div>
            <span>Processing...</span>
          </ng-container>
          <ng-template #btnText>
            <span *ngIf="!emailChecked">Continue</span>
            <span *ngIf="emailChecked">Sign In</span>
          </ng-template>
        </button>
      </form>
    </div>

    <!-- Step 3: Domain & Role Selection -->
    <div *ngIf="showDomainSelection" class="animate-fade-in space-y-5">
      <div class="text-center mb-4">
        <p class="text-gray-600">Select your workspace</p>
        <p class="text-sm font-medium text-gray-800">{{ email }}</p>
      </div>

      <!-- Domain Selection -->
      <div class="space-y-1.5">
        <label class="block text-sm font-semibold text-gray-700 ml-1"
          >Domain</label
        >
        <select
          [ngModel]="selectedDomainId"
          (ngModelChange)="selectDomain($event)"
          class="input-field"
        >
          <option [ngValue]="null" disabled>Select Domain</option>
          <option *ngFor="let domain of domains" [ngValue]="domain.domain_id">
            {{ domain.domain_name }}
          </option>
        </select>
      </div>

      <!-- Role Selection -->
      <div class="space-y-1.5" *ngIf="selectedDomainId">
        <label class="block text-sm font-semibold text-gray-700 ml-1"
          >Role</label
        >
        <select [(ngModel)]="selectedRole" class="input-field">
          <option value="" disabled>Select Role</option>
          <option *ngFor="let role of availableRoles" [value]="role">
            {{ role | titlecase }}
          </option>
        </select>
      </div>

      <!-- OTP Input -->
      <div *ngIf="showOtpInput" class="space-y-3 animate-fade-in pt-2">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p class="text-sm text-blue-800 text-center">
            Enter 2FA Code sent to email
          </p>
        </div>
        <input
          type="text"
          [(ngModel)]="otp"
          maxlength="6"
          class="input-field text-center text-lg tracking-widest font-mono"
          placeholder="000000"
        />
      </div>

      <!-- Error Message -->
      <div
        *ngIf="error"
        class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm animate-shake"
      >
        {{ error }}
      </div>

      <!-- Complete Login Button -->
      <button
        (click)="completeLogin()"
        [disabled]="
          loading ||
          !selectedDomainId ||
          !selectedRole ||
          (showOtpInput && otp.length < 6)
        "
        class="btn-primary w-full py-3 font-semibold flex items-center justify-center gap-2"
      >
        <ng-container *ngIf="loading; else completeBtnText">
          <div
            class="animate-spin h-5 w-5 border-b-2 border-white rounded-full"
          ></div>
          <span>Logging in...</span>
        </ng-container>
        <ng-template #completeBtnText>
          <span>Complete Login</span>
        </ng-template>
      </button>

      <button
        (click)="resetForm()"
        class="w-full text-center text-sm text-gray-500 hover:text-gray-700 mt-4"
      >
        Back to Sign In
      </button>
    </div>

    <!-- Signup options -->
    <p
      class="mt-8 text-center text-sm text-gray-500"
      *ngIf="!showDomainSelection"
    >
      <span *ngIf="signupEnabled && !emailChecked">
        Don't have an account?
        <a
          routerLink="/signup"
          class="text-primary-600 hover:text-primary-700 font-semibold hover:underline"
        >
          Create account
        </a>
      </span>
      <span *ngIf="!signupEnabled && !emailChecked">
        Access restricted to authorized personnel only.
      </span>
    </p>
  </div>
</div>
